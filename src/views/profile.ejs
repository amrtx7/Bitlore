<%- include('partials/header') %>
    <%- include('partials/nav') %>

        <body class="profile-layout">


            <div class="main">
                <div class="container">
                    <!-- PROFILE HEADER -->
                    <section class="profile-header">
                        <div class="avatar">
                            <span>
                                <%= profile.name[0].toUpperCase() %>
                            </span>
                        </div>
                        
                        <div class="profile-info">
                            <h1>
                                <%= profile.name %>
                            </h1>
                            <p class="username">@<%= profile.username %>
                            </p>
                            <p class="bio">
                                Writing thoughts, ideas and stories worth sharing.
                            </p>
                            
                            
                            <div class="stats">
                                <% if (profile.createdAt) { %>
                                    <span>Joined on <%= profile.createdAt.toString().split(" ").splice(1,3).join(" ") %></span>
                                <% } %>
                                <p>Blogs : <strong><%= blogsLength %></strong>
                                </p>
                            </div>
                        </div>
                    </section>
                    <% if (blogs.length===0) { %>

                        <div class="no-blogs-posted">
                            <h2>No blogs posted.</h2>
                            <h2>Write your first blog now!</h2>
                            <% if (user._id.toString() === profile._id.toString()) { %>
                                <button class="btn"><a href="/<%= user._id %>/write">Write</a></button>
                            <% } %>
                        </div>

                    <% } else { %>
                            <p><strong>Featured</strong></p>
                            <div class="blogs">
                            <ul>
                                <% blogs.forEach(blog=> { %>
                                    <li class="blog-card">
                                        <a class="author" href="/@<%= blog.author.username %>">
                                                <div class="avatar">
                            <span>
                                <%= blog.author.name[0].toUpperCase() %>
                            </span>
                        </div>
                                                <p class="author-name">
                                                <%= blog.author.name %>
                                                </p>

                                            </a>
                                        
                                        <a class="title" href="/blogs/<%= blog.slug %>">
                                            <%= blog.title %>
                                        </a>

                                        <p class="desc">
                                            <%= blog.content %>
                                        </p>

                                        <p class="details">
                                                <%= blog.createdAt.toString().split(" ").splice(1,3).join(" ") %>
                                        </p>

                                        <% if (isUser || user.role==="admin") { %>
                                            <div class="actions">
                                                <button class="action-btn delBtn" data-blog-id="<%= blog._id %>"
                                                    data-blog-name="<%= blog.title %>">Delete</button>
                                                    <button class="action-btn editBtn" data-blog-id="<%= blog._id %>"
                                                        data-blog-name="<%= blog.title %>"
                                                        data-blog-content="<%= blog.content %>">Edit</button>
                                                        
                                                    </div>
                                                    <% } %>
                                                    <div class=" divider"></div>
                                     </li>
                                 <% }) %>
                            </ul>
                      </div>
                            <% } %>
                </div>
            </div>

            <%- include('partials/footer') %>

                <script>
                    const blogList = document.querySelector('.blogs')
                    if (blogList) {  // what if the user doesnt have any blog written yet.
                        blogList.addEventListener('click', (event) => {
                            const blogId = event.target.dataset.blogId
                            const blogName = event.target.dataset.blogName
                            if (event.target.classList.contains('editBtn')) {
                                // const title = event.target.dataset.blogId
                                editBlog(blogId, blogName)
                                return
                            }
                            if (!event.target.classList.contains('delBtn')) {
                                return
                            }
                            else {
                                if (confirm('Do you want to delete this blog?')) {
                                    deleteBlog(blogId, blogName)
                                    event.target.closest('li').remove()
                                }
                            }
                        })
                    }
                    const editBlog = async (blogId, blogName) => {
                        location.assign(`/blog/${blogId}/edit`)
                    }

                    const deleteBlog = async (blogId, blogName) => {
                        const data = await fetch(`/blog/${blogId}`, {
                            method: 'DELETE'
                        })
                        const response = await data.json()
                        console.log("Deleted")
                        console.log(response)
                        if (response.ok) {
                            console.log('Blog deleted successfully', blogName)
                            // location.assign(`/@${response.username}`)
                            // later if mood changes to redirect or refresh
                        } else {
                            console.log("Server side Error")
                        }
                    }


                </script>

        </body>